<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 10px; background-color: #f4f4f4; color: #333; }
    h3 { margin-top: 0; margin-bottom: 15px; color: #2c3e50; font-size: 16px; border-bottom: 2px solid #ddd; padding-bottom: 5px; }
    
    /* Cards */
    .card { background: white; border-radius: 6px; padding: 12px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid #3498db; }
    .card.vision { border-left-color: #9b59b6; }
    .card.tooling { border-left-color: #e67e22; }
    
    .label { font-weight: bold; font-size: 11px; color: #7f8c8d; text-transform: uppercase; display: block; margin-bottom: 6px; }
    
    /* Inputs */
    select { width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 4px; background: white; font-size: 13px; }
    select:focus { border-color: #3498db; outline: none; }
    
    /* Loading */
    .hidden { display: none; }
    .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 24px; height: 24px; animation: spin 0.8s linear infinite; margin: 15px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* Lists */
    .read-only-text { background: #ecf0f1; padding: 8px; border-radius: 4px; font-size: 12px; color: #2c3e50; border: 1px solid #bdc3c7; }
    ul.tool-list { list-style: none; padding: 0; margin: 0; }
    li.tool-item { padding: 10px 0; border-bottom: 1px solid #eee; }
    li.tool-item:last-child { border-bottom: none; }
    
    .part-id { font-weight: 700; color: #2c3e50; font-size: 13px; display: block; }
    .part-desc { font-size: 11px; color: #7f8c8d; display: block; margin-bottom: 5px; }
    
    /* Alerts */
    .required-select { border: 2px solid #e74c3c; background-color: #fffafa; margin-top: 5px; }
    .alert-label { color: #e74c3c; font-size: 10px; font-weight: 800; margin-top: 6px; display: block; }
    
    /* Buttons */
    .btn-group { margin-top: 15px; border-top: 1px solid #ddd; padding-top: 10px; }
    button { width: 100%; padding: 10px; background-color: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; margin-bottom: 5px; }
    button:hover { background-color: #219150; }
    button#btnSave { background-color: #2980b9; }
    button#btnSave:hover { background-color: #2c3e50; }
    button#btnClose { background-color: #95a5a6; }
    button:disabled { background-color: #bdc3c7; cursor: not-allowed; }

    /* OptGroup Styling */
    optgroup { font-weight: bold; color: #2c3e50; }
  </style>
</head>
<body>

  <h3>Module Configurator</h3>
  
  <!-- Step 1: Module Selector -->
  <div class="card">
    <span class="label">1. Select Module</span>
    <select id="moduleSelect" onchange="loadModuleData()">
      <option value="" disabled selected>Loading...</option>
    </select>
  </div>

  <!-- Loading State -->
  <div id="loading" class="hidden">
    <div class="spinner"></div>
    <div id="loadingText" style="text-align:center; font-size:11px; color:#7f8c8d;">Processing Dependencies...</div>
  </div>

  <!-- Step 2: Configuration Form -->
  <div id="configContainer" class="hidden">
    
    <!-- Electrical -->
    <div class="card">
      <span class="label">Electrical (Auto-Assigned)</span>
      <div id="elecBox" class="read-only-text">None</div>
    </div>

    <!-- Tooling -->
    <div class="card tooling">
      <span class="label">Tooling & Tips</span>
      <ul id="toolList" class="tool-list"></ul>
    </div>

    <!-- Vision -->
    <div id="visionCard" class="card vision hidden">
      <span class="label">Vision System</span>
      <select id="visionSelect"></select>
    </div>
    
    <!-- Jigs -->
    <div class="card">
      <span class="label">Jigs (Included)</span>
      <div id="jigsBox" style="font-size:11px; color:#7f8c8d;">None</div>
    </div>

    <div class="btn-group">
      <button id="btnSave" onclick="saveConfiguration()">Save Configuration</button>
      <button onclick="logSelection()">Check JSON (Debug)</button>
      <button id="btnClose" onclick="google.script.host.close()">Close</button>
    </div>
  </div>

  <script>
    // GLOBAL STATE to hold raw data
    var currentConfigData = null;

    window.onload = function() {
      google.script.run.withSuccessHandler(populateModuleDropdown).getModuleList();
    };

    function populateModuleDropdown(modules) {
      var select = document.getElementById("moduleSelect");
      select.innerHTML = '<option value="" disabled selected>Select a Module...</option>';
      modules.forEach(function(m) {
        var opt = document.createElement("option");
        opt.value = m.id;
        // Display: ID | Description
        opt.text = m.id + " | " + m.desc;
        select.appendChild(opt);
      });
    }

    function loadModuleData() {
      var moduleID = document.getElementById("moduleSelect").value;
      if(!moduleID) return;

      document.getElementById("loading").classList.remove("hidden");
      document.getElementById("loadingText").textContent = "Processing Dependencies...";
      document.getElementById("configContainer").classList.add("hidden");

      google.script.run.withSuccessHandler(renderConfiguration).getModuleDetails(moduleID);
    }

    function renderConfiguration(data) {
      // SAVE TO GLOBAL STATE
      currentConfigData = data;

      document.getElementById("loading").classList.add("hidden");
      document.getElementById("configContainer").classList.remove("hidden");
      
      console.log("Config Data:", data);

      // 1. Electrical
      var elecBox = document.getElementById("elecBox");
      if (data.electrical) {
        elecBox.textContent = data.electrical.id + " (" + data.electrical.desc + ")";
      } else {
        elecBox.textContent = "No Electrical Kit required.";
      }

      // 2. Tooling
      var toolList = document.getElementById("toolList");
      toolList.innerHTML = "";
      
      if (data.tools && data.tools.length > 0) {
        data.tools.forEach(function(tool) {
          var li = document.createElement("li");
          li.className = "tool-item";
          
          var html = '<span class="part-id">' + tool.id + '</span>';
          html += '<span class="part-desc">' + tool.desc + '</span>';
          
          // Standard Options
          if (tool.standardOptions && tool.standardOptions.length > 0) {
             html += '<select id="opt_' + tool.id + '" style="margin-top:4px;">';
             html += '<option value="" disabled selected>Select Option...</option>';
             html += buildCategorizedOptions(tool.standardOptions);
             html += '</select>';
          }
          
          // RUBBER TIP REQUIRED ALERT
          if (tool.requiresRubberTip) {
            html += '<span class="alert-label">âš  SELECTION REQUIRED:</span>';
            html += '<select id="tip_' + tool.id + '" class="required-select">';
            html += '<option value="" disabled selected>Select Rubber Tip...</option>';
            if (tool.rubberTipOptions) {
               html += buildCategorizedOptions(tool.rubberTipOptions);
            }
            html += '</select>';
          }
          
          li.innerHTML = html;
          toolList.appendChild(li);
        });
      } else {
        toolList.innerHTML = '<li class="tool-item" style="text-align:center; color:#999; font-size:12px;">No Tools required.</li>';
      }

      // 3. Vision
      var visionCard = document.getElementById("visionCard");
      var visionSelect = document.getElementById("visionSelect");
      
      if (data.vision.type === 'select') {
        visionCard.classList.remove("hidden");
        visionSelect.innerHTML = '<option value="" disabled selected>Select Vision...</option>';
        data.vision.options.forEach(function(opt){
           var o = document.createElement("option");
           o.value = opt.id;
           o.text = opt.id + " - " + opt.desc;
           visionSelect.appendChild(o);
        });
      } else if (data.vision.type === 'fixed') {
         visionCard.classList.remove("hidden");
         var fixedOpt = data.vision.options[0];
         // Store value but disable selection
         visionSelect.innerHTML = '<option value="' + fixedOpt.id + '" selected disabled>' + fixedOpt.id + ' (' + fixedOpt.desc + ')</option>';
      } else {
        visionCard.classList.add("hidden");
        visionSelect.innerHTML = ""; // Clear
      }
      
      // 4. Jigs
      var jigsBox = document.getElementById("jigsBox");
      if (data.jigs && data.jigs.length > 0) {
         jigsBox.innerHTML = data.jigs.map(j => j.id + " <span style='color:#999'>(" + j.desc + ")</span>").join("<br>");
      } else {
         jigsBox.textContent = "No Jigs required.";
      }
    }
    
    function buildCategorizedOptions(optionsArray) {
       var html = "";
       var currentCategory = null;
       var isGroupOpen = false;
       
       optionsArray.forEach(function(opt) {
          if (opt.category !== currentCategory) {
             if (isGroupOpen) { html += '</optgroup>'; isGroupOpen = false; }
             if (opt.category) { html += '<optgroup label="' + opt.category + '">'; isGroupOpen = true; }
             currentCategory = opt.category;
          }
          var displayText = opt.id;
          if(opt.desc) displayText += " | " + opt.desc;
          html += '<option value="' + opt.id + '">' + displayText + '</option>';
       });
       if (isGroupOpen) html += '</optgroup>';
       return html;
    }

    // --- PHASE 2: DATA COLLECTION & SAVE ---
    function collectPayload() {
      if (!currentConfigData) return null;

      // 1. Module Info
      var moduleSelect = document.getElementById("moduleSelect");
      var moduleFullText = moduleSelect.options[moduleSelect.selectedIndex].text;
      var moduleDescClean = moduleFullText.split(" | ")[1] || ""; // Get text after pipe
      
      var payload = {
        moduleID: currentConfigData.moduleID,
        moduleDesc: moduleDescClean,
        elecID: "",
        visionID: "",
        jigID: "",
        toolOptionID: "",
        rubberTipID: ""
      };

      // 2. Electrical
      if (currentConfigData.electrical && currentConfigData.electrical.id) {
        payload.elecID = currentConfigData.electrical.id;
      }

      // 3. Vision
      var visionSelect = document.getElementById("visionSelect");
      if (visionSelect && visionSelect.value) {
        payload.visionID = visionSelect.value;
      } else if (currentConfigData.vision.type === 'fixed' && currentConfigData.vision.options.length > 0) {
         // Fallback for fixed vision if disabled select isn't captured (though .value should work)
         payload.visionID = currentConfigData.vision.options[0].id;
      }

      // 4. Jigs (First one only per instruction)
      if (currentConfigData.jigs && currentConfigData.jigs.length > 0) {
        payload.jigID = currentConfigData.jigs[0].id;
      }

      // 5. Tooling (Dynamic Selection)
      // Find active tool dropdowns
      var optSelect = document.querySelector('select[id^="opt_"]');
      if (optSelect && optSelect.value) {
        payload.toolOptionID = optSelect.value;
      }

      var tipSelect = document.querySelector('select[id^="tip_"]');
      if (tipSelect && tipSelect.value) {
        payload.rubberTipID = tipSelect.value;
      }

      return payload;
    }

    function saveConfiguration() {
      var payload = collectPayload();
      if (!payload) return;

      // Basic Validation
      if (!payload.moduleID) {
        alert("Error: No Module Selected.");
        return;
      }

      // UI Feedback
      var btn = document.getElementById("btnSave");
      btn.disabled = true;
      btn.textContent = "Saving...";
      document.getElementById("loading").classList.remove("hidden");
      document.getElementById("loadingText").textContent = "Writing to Trial Layout...";
      document.getElementById("configContainer").classList.add("hidden");

      // Send to Backend
      google.script.run
        .withSuccessHandler(function(response) {
           document.getElementById("loading").classList.add("hidden");
           document.getElementById("configContainer").classList.remove("hidden");
           btn.disabled = false;
           btn.textContent = "Save Configuration";
           alert("Success! Saved to " + response.slot);
        })
        .withFailureHandler(function(err) {
           document.getElementById("loading").classList.add("hidden");
           document.getElementById("configContainer").classList.remove("hidden");
           btn.disabled = false;
           btn.textContent = "Save Configuration";
           alert("Error: " + err.message);
        })
        .saveConfiguration(payload);
    }

    function logSelection() {
      console.log("Current Payload:", collectPayload());
    }
  </script>
</body>
</html>
