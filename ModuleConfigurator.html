<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 10px; background-color: #f4f4f4; color: #333; }
    
    /* Navigation Tabs */
    .nav-bar { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 15px; }
    .nav-btn { flex: 1; padding: 10px; text-align: center; cursor: pointer; background: #ecf0f1; border: none; font-weight: 600; color: #7f8c8d; }
    .nav-btn.active { background: white; border-bottom: 3px solid #3498db; color: #2c3e50; }
    
    h3 { margin-top: 0; margin-bottom: 15px; color: #2c3e50; font-size: 16px; border-bottom: 2px solid #ddd; padding-bottom: 5px; }
    
    /* Cards */
    .card { background: white; border-radius: 6px; padding: 12px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid #3498db; }
    .card.vision { border-left-color: #9b59b6; }
    .card.tooling { border-left-color: #e67e22; }
    .card.spare { border-left-color: #27ae60; } 
    .card.layout { border-left-color: #e74c3c; } /* Red for Layout/Flags */
    .card.qty { border-left-color: #f1c40f; } /* Yellow for Qty */
    .card.setup { border-left-color: #8e44ad; } /* Purple for Machine Setup */
    
    .label { font-weight: bold; font-size: 11px; color: #7f8c8d; text-transform: uppercase; display: block; margin-bottom: 6px; }
    
    /* Inputs */
    select, input[type="text"] { width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 4px; background: white; font-size: 13px; box-sizing: border-box; }
    select:focus, input:focus { border-color: #3498db; outline: none; }
    input[type="text"].hidden { display: none; }
    input[type="text"] { margin-top: 5px; }
    
    /* Radio Styling */
    .radio-group { margin-bottom: 10px; }
    .radio-item { display: flex; align-items: start; margin-bottom: 6px; font-size: 12px; color: #2c3e50; }
    .radio-item input { margin-right: 8px; margin-top: 2px; }
    
    /* Loading */
    .hidden { display: none; }
    .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 24px; height: 24px; animation: spin 0.8s linear infinite; margin: 15px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* Lists */
    .read-only-text { background: #ecf0f1; padding: 8px; border-radius: 4px; font-size: 12px; color: #2c3e50; border: 1px solid #bdc3c7; }
    ul.tool-list { list-style: none; padding: 0; margin: 0; }
    li.tool-item { padding: 10px 0; border-bottom: 1px solid #eee; }
    li.tool-item:last-child { border-bottom: none; }
    
    .part-id { font-weight: 700; color: #2c3e50; font-size: 13px; display: block; }
    .part-desc { font-size: 11px; color: #7f8c8d; display: block; margin-bottom: 5px; }
    
    /* Alerts */
    .required-select { border: 2px solid #e74c3c; background-color: #fffafa; margin-top: 5px; }
    .alert-label { color: #e74c3c; font-size: 10px; font-weight: 800; margin-top: 6px; display: block; }
    
    /* Buttons */
    .btn-group { margin-top: 15px; border-top: 1px solid #ddd; padding-top: 10px; }
    button { width: 100%; padding: 10px; background-color: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; margin-bottom: 5px; }
    button:hover { background-color: #219150; }
    button#btnSave { background-color: #2980b9; }
    button#btnSave:hover { background-color: #2c3e50; }
    button#btnClose { background-color: #95a5a6; }
    button:disabled { background-color: #bdc3c7; cursor: not-allowed; }

    /* OptGroup Styling */
    optgroup { font-weight: bold; color: #2c3e50; }
  </style>
</head>
<body>

  <!-- NAVIGATION TABS -->
  <div class="nav-bar">
    <div id="tabModule" class="nav-btn active" onclick="switchTab('MODULE')">Modules</div>
    <div id="tabSetup" class="nav-btn" onclick="switchTab('SETUP')">Machine Setup</div>
  </div>

  <!-- Loading State -->
  <div id="loading" class="hidden">
    <div class="spinner"></div>
    <div id="loadingText" style="text-align:center; font-size:11px; color:#7f8c8d;">Processing...</div>
  </div>

  <!-- VIEW 1: MODULE CONFIGURATOR -->
  <div id="viewModule">
      <h3>Module Configurator</h3>
      
      <!-- Step 1: Module Selector -->
      <div class="card">
        <span class="label">1. Select Module</span>
        <select id="moduleSelect" onchange="loadModuleData()">
          <option value="" disabled selected>Loading...</option>
        </select>
      </div>

      <!-- Step 2: Configuration Form -->
      <div id="configContainer" class="hidden">
        
        <!-- Electrical -->
        <div class="card">
          <span class="label">Electrical (Auto-Assigned)</span>
          <div id="elecBox" class="read-only-text">None</div>
        </div>

        <!-- Tooling -->
        <div class="card tooling">
          <span class="label">Tooling & Tips</span>
          <ul id="toolList" class="tool-list"></ul>
        </div>

        <!-- Vision -->
        <div id="visionCard" class="card vision hidden">
          <span class="label">Vision System</span>
          <select id="visionSelect"></select>
        </div>
        
        <!-- Jigs -->
        <div class="card">
          <span class="label">Jigs (Included)</span>
          <div id="jigsBox" style="font-size:11px; color:#7f8c8d;">None</div>
        </div>

        <!-- Spare Parts -->
        <div id="spareCard" class="card spare hidden">
          <span class="label">Spare Parts (Bundle)</span>
          <ul id="spareList" class="tool-list" style="margin-bottom: 8px;"></ul>
          
          <span class="alert-label">⚠ DECISION REQUIRED:</span>
          <select id="spareSelect" class="required-select">
            <option value="" selected>Select Option...</option>
            <option value="yes">Yes, Include All</option>
            <option value="no">No, Skip</option>
          </select>
        </div>

        <!-- NEW: Quantity Selector (Phase 4.1) -->
        <div class="card qty">
          <span class="label">Number of Vision Systems (Qty)</span>
          <select id="numVisionSelect">
            <option value="1" selected>1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
          </select>
        </div>

        <!-- Layout Settings (NEW) -->
        <div class="card layout">
          <span class="label">Machine Layout Settings (Optional)</span>
          
          <div style="margin-bottom: 10px;">
            <span id="vcmTitle" class="part-desc" style="font-weight:bold; margin-bottom:4px;">VCM Configuration</span>
            <div id="vcmContainer" class="radio-group">Loading...</div>
          </div>
          
          <div>
             <span id="valveTitle" class="part-desc" style="font-weight:bold; margin-bottom:4px;">Valve Set Configuration</span>
             <div id="valveContainer" class="radio-group">Loading...</div>
          </div>
        </div>

        <div class="btn-group">
          <button id="btnSave" onclick="saveConfiguration()">Save Module Config</button>
          <button id="btnClose" onclick="google.script.host.close()">Close</button>
        </div>
      </div>
  </div>

  <!-- VIEW 2: MACHINE SETUP (NEW PHASE 6) -->
  <div id="viewSetup" class="hidden">
      <h3>Machine Setup</h3>

      <!-- 1. Vision PC -->
      <div class="card setup">
          <span class="label">1. Vision PC</span>
          <select id="visionPCSelect" onchange="handleVisionPCChange()">
              <option value="" disabled selected>Loading Options...</option>
          </select>
          <input type="text" id="visionPCOtherInput" class="hidden" placeholder="Enter Custom Part ID (Required)">
      </div>

      <!-- Placeholders for Future Items -->
      <div class="card setup" style="opacity: 0.6;">
          <span class="label">2. Configurable Base Module (Coming Soon)</span>
          <div class="read-only-text">Pending Implementation</div>
      </div>
      
       <div class="card setup" style="opacity: 0.6;">
          <span class="label">3. Base Module Tooling (Coming Soon)</span>
           <div class="read-only-text">Pending Implementation</div>
      </div>

      <div class="btn-group">
          <button id="btnSaveSetup" onclick="saveMachineSetup()">Save Machine Setup</button>
          <button onclick="google.script.host.close()">Close</button>
      </div>
  </div>

  <script>
    // GLOBAL STATE to hold raw data
    var currentConfigData = null;
    var isSetupLoaded = false;

    window.onload = function() {
      // Load Module Data on Start
      google.script.run.withSuccessHandler(populateModuleDropdown).getModuleList();
      google.script.run.withSuccessHandler(renderLayoutSettings).getLayoutHeaders();
    };

    // --- TAB SWITCHER LOGIC ---
    function switchTab(tabName) {
        if (tabName === 'MODULE') {
            document.getElementById('viewModule').classList.remove('hidden');
            document.getElementById('viewSetup').classList.add('hidden');
            document.getElementById('tabModule').classList.add('active');
            document.getElementById('tabSetup').classList.remove('active');
        } else {
            document.getElementById('viewModule').classList.add('hidden');
            document.getElementById('viewSetup').classList.remove('hidden');
            document.getElementById('tabModule').classList.remove('active');
            document.getElementById('tabSetup').classList.add('active');
            
            // Lazy Load Setup Data only once
            if (!isSetupLoaded) {
                loadSetupData();
            }
        }
    }

    // --- MACHINE SETUP LOGIC (NEW) ---
    function loadSetupData() {
        var sel = document.getElementById("visionPCSelect");
        sel.innerHTML = '<option value="" disabled selected>Loading...</option>';
        
        google.script.run.withSuccessHandler(function(options) {
            renderVisionPCOptions(options);
            isSetupLoaded = true;
        }).getVisionPCOptions();
    }

    function renderVisionPCOptions(options) {
        var sel = document.getElementById("visionPCSelect");
        sel.innerHTML = '<option value="" disabled selected>Select Vision PC...</option>';
        
        options.forEach(function(opt) {
            var el = document.createElement("option");
            el.value = opt.id;
            el.text = opt.id + " | " + opt.desc;
            sel.appendChild(el);
        });
        
        // Add "Other" Option
        var otherEl = document.createElement("option");
        otherEl.value = "OTHER";
        otherEl.text = "Other (Manual Input)";
        sel.appendChild(otherEl);
    }

    function handleVisionPCChange() {
        var val = document.getElementById("visionPCSelect").value;
        var input = document.getElementById("visionPCOtherInput");
        
        if (val === "OTHER") {
            input.classList.remove("hidden");
            input.focus();
        } else {
            input.classList.add("hidden");
            input.value = ""; // Clear manual input if they switch back
        }
    }

    function saveMachineSetup() {
        var payload = {};
        
        // 1. Vision PC Logic
        var visionSelect = document.getElementById("visionPCSelect");
        var visionVal = visionSelect.value;
        
        if (!visionVal) {
            alert("Please select a Vision PC.");
            return;
        }
        
        if (visionVal === "OTHER") {
            var manualVal = document.getElementById("visionPCOtherInput").value;
            if (!manualVal.trim()) {
                alert("Please enter a Custom Part ID for 'Other'.");
                return;
            }
            payload.visionPC = manualVal.trim();
        } else {
            payload.visionPC = visionVal;
        }
        
        // UI Feedback
        var btn = document.getElementById("btnSaveSetup");
        btn.disabled = true;
        btn.textContent = "Saving...";
        
        google.script.run
            .withSuccessHandler(function() {
                alert("Machine Setup Saved Successfully!");
                btn.disabled = false;
                btn.textContent = "Save Machine Setup";
            })
            .withFailureHandler(function(err) {
                alert("Error: " + err.message);
                btn.disabled = false;
                btn.textContent = "Save Machine Setup";
            })
            .saveMachineSetup(payload);
    }

    // --- MODULE CONFIGURATOR LOGIC (EXISTING) ---

    function populateModuleDropdown(modules) {
      var select = document.getElementById("moduleSelect");
      select.innerHTML = '<option value="" disabled selected>Select a Module...</option>';
      modules.forEach(function(m) {
        var opt = document.createElement("option");
        opt.value = m.id;
        opt.text = m.id + " | " + m.desc;
        select.appendChild(opt);
      });
    }
    
    // (NEW) Render Radio Buttons for Layout
    function renderLayoutSettings(data) {
      if (!data) return;
      
      // Helper to build radio buttons
      function buildRadioGroup(containerId, items, groupName) {
        var container = document.getElementById(containerId);
        container.innerHTML = "";
        
        // Add "None" option first
        var noneHtml = '<label class="radio-item"><input type="radio" name="' + groupName + '" value="-1" checked> None</label>';
        container.innerHTML += noneHtml;
        
        items.forEach(function(item) {
           var html = '<label class="radio-item">';
           html += '<input type="radio" name="' + groupName + '" value="' + item.colIndex + '">';
           html += item.label; // Dynamic Label from Row 6
           html += '</label>';
           container.innerHTML += html;
        });
      }
      
      // Set Titles (Row 5 Data)
      if (data.group1) {
          document.getElementById("vcmTitle").textContent = data.group1.title;
          buildRadioGroup("vcmContainer", data.group1.options, "vcmGroup");
      }
      
      if (data.group2) {
          document.getElementById("valveTitle").textContent = data.group2.title;
          buildRadioGroup("valveContainer", data.group2.options, "valveGroup");
      }
    }

    function loadModuleData() {
      var moduleID = document.getElementById("moduleSelect").value;
      if(!moduleID) return;

      document.getElementById("loading").classList.remove("hidden");
      document.getElementById("loadingText").textContent = "Processing Dependencies...";
      document.getElementById("configContainer").classList.add("hidden");

      google.script.run.withSuccessHandler(renderConfiguration).getModuleDetails(moduleID);
    }

    function renderConfiguration(data) {
      currentConfigData = data;

      document.getElementById("loading").classList.add("hidden");
      document.getElementById("configContainer").classList.remove("hidden");
      
      console.log("Config Data:", data);

      // 1. Electrical
      var elecBox = document.getElementById("elecBox");
      if (data.electrical) {
        elecBox.textContent = data.electrical.id + " (" + data.electrical.desc + ")";
      } else {
        elecBox.textContent = "No Electrical Kit required.";
      }

      // 2. Tooling
      var toolList = document.getElementById("toolList");
      toolList.innerHTML = "";
      
      if (data.tools && data.tools.length > 0) {
        data.tools.forEach(function(tool) {
          var li = document.createElement("li");
          li.className = "tool-item";
          
          var html = '<span class="part-id">' + tool.id + '</span>';
          html += '<span class="part-desc">' + tool.desc + '</span>';
          
          if (tool.standardOptions && tool.standardOptions.length > 0) {
             html += '<select id="opt_' + tool.id + '" style="margin-top:4px;">';
             html += '<option value="" disabled selected>Select Option...</option>';
             html += buildCategorizedOptions(tool.standardOptions);
             html += '</select>';
          }
          
          if (tool.requiresRubberTip) {
            html += '<span class="alert-label">⚠ SELECTION REQUIRED:</span>';
            html += '<select id="tip_' + tool.id + '" class="required-select">';
            html += '<option value="" disabled selected>Select Rubber Tip...</option>';
            if (tool.rubberTipOptions) {
               html += buildCategorizedOptions(tool.rubberTipOptions);
            }
            html += '</select>';
          }
          
          li.innerHTML = html;
          toolList.appendChild(li);
        });
      } else {
        toolList.innerHTML = '<li class="tool-item" style="text-align:center; color:#999; font-size:12px;">No Tools required.</li>';
      }

      // 3. Vision
      var visionCard = document.getElementById("visionCard");
      var visionSelect = document.getElementById("visionSelect");
      
      if (data.vision.type === 'select') {
        visionCard.classList.remove("hidden");
        visionSelect.innerHTML = '<option value="" disabled selected>Select Vision...</option>';
        data.vision.options.forEach(function(opt){
           var o = document.createElement("option");
           o.value = opt.id;
           o.text = opt.id + " - " + opt.desc;
           visionSelect.appendChild(o);
        });
      } else if (data.vision.type === 'fixed') {
         visionCard.classList.remove("hidden");
         var fixedOpt = data.vision.options[0];
         visionSelect.innerHTML = '<option value="' + fixedOpt.id + '" selected disabled>' + fixedOpt.id + ' (' + fixedOpt.desc + ')</option>';
      } else {
        visionCard.classList.add("hidden");
        visionSelect.innerHTML = ""; 
      }
      
      // 4. Jigs
      var jigsBox = document.getElementById("jigsBox");
      if (data.jigs && data.jigs.length > 0) {
         jigsBox.innerHTML = data.jigs.map(j => j.id + " <span style='color:#999'>(" + j.desc + ")</span>").join("<br>");
      } else {
         jigsBox.textContent = "No Jigs required.";
      }

      // 5. Spare Parts
      var spareCard = document.getElementById("spareCard");
      var spareList = document.getElementById("spareList");
      var spareSelect = document.getElementById("spareSelect");

      spareSelect.value = ""; 
      spareList.innerHTML = "";

      if (data.spareParts && data.spareParts.length > 0) {
        spareCard.classList.remove("hidden");
        data.spareParts.forEach(function(part) {
           var li = document.createElement("li");
           li.className = "tool-item";
           li.innerHTML = '<span class="part-id">' + part.id + '</span><span class="part-desc">' + part.desc + '</span>';
           spareList.appendChild(li);
        });
      } else {
        spareCard.classList.add("hidden");
      }
      
      // (NEW) Reset Quantity to 1
      document.getElementById("numVisionSelect").value = "1";
    }
    
    function buildCategorizedOptions(optionsArray) {
       var html = "";
       var currentCategory = null;
       var isGroupOpen = false;
       
       optionsArray.forEach(function(opt) {
          if (opt.category !== currentCategory) {
             if (isGroupOpen) { html += '</optgroup>'; isGroupOpen = false; }
             if (opt.category) { html += '<optgroup label="' + opt.category + '">'; isGroupOpen = true; }
             currentCategory = opt.category;
          }
          var displayText = opt.id;
          if(opt.desc) displayText += " | " + opt.desc;
          html += '<option value="' + opt.id + '">' + displayText + '</option>';
       });
       if (isGroupOpen) html += '</optgroup>';
       return html;
    }

    // --- PHASE 2: DATA COLLECTION & SAVE ---
    function collectPayload() {
      if (!currentConfigData) return null;

      var moduleSelect = document.getElementById("moduleSelect");
      var moduleFullText = moduleSelect.options[moduleSelect.selectedIndex].text;
      var moduleDescClean = moduleFullText.split(" | ")[1] || ""; 
      
      // (NEW) Get Quantity
      var numVision = document.getElementById("numVisionSelect").value || "1";
      
      var payload = {
        moduleID: currentConfigData.moduleID,
        moduleDesc: moduleDescClean,
        elecID: "",
        visionID: "",
        jigID: "",
        toolOptionID: "",
        rubberTipID: "",
        sparePartsID: "",
        numberVision: numVision, // NEW for Phase 4.1
        layoutFlags: {} 
      };

      if (currentConfigData.electrical && currentConfigData.electrical.id) {
        payload.elecID = currentConfigData.electrical.id;
      }

      var visionSelect = document.getElementById("visionSelect");
      if (visionSelect && visionSelect.value) {
        payload.visionID = visionSelect.value;
      } else if (currentConfigData.vision.type === 'fixed' && currentConfigData.vision.options.length > 0) {
         payload.visionID = currentConfigData.vision.options[0].id;
      }

      if (currentConfigData.jigs && currentConfigData.jigs.length > 0) {
        payload.jigID = currentConfigData.jigs[0].id;
      }

      var optSelect = document.querySelector('select[id^="opt_"]');
      if (optSelect && optSelect.value) {
        payload.toolOptionID = optSelect.value;
      }

      var tipSelect = document.querySelector('select[id^="tip_"]');
      if (tipSelect && tipSelect.value) {
        payload.rubberTipID = tipSelect.value;
      }

      // Spare Parts Validation
      var spareCard = document.getElementById("spareCard");
      if (!spareCard.classList.contains("hidden")) {
         var decision = document.getElementById("spareSelect").value;
         if (decision === "") {
            alert("Please decide whether to include Spare Parts (Yes/No).");
            return null; 
         } else if (decision === "yes") {
            var ids = currentConfigData.spareParts.map(function(p){ return p.id; }).join("; ");
            payload.sparePartsID = ids;
         } else {
            payload.sparePartsID = ""; 
         }
      }
      
      // Collect Layout Flags
      var vcmRadio = document.querySelector('input[name="vcmGroup"]:checked');
      if (vcmRadio && vcmRadio.value !== "-1") {
         payload.layoutFlags[vcmRadio.value] = true;
      }
      var valveRadio = document.querySelector('input[name="valveGroup"]:checked');
      if (valveRadio && valveRadio.value !== "-1") {
         payload.layoutFlags[valveRadio.value] = true;
      }

      return payload;
    }

    function saveConfiguration() {
      var payload = collectPayload();
      if (!payload) return; 

      if (!payload.moduleID) {
        alert("Error: No Module Selected.");
        return;
      }

      var btn = document.getElementById("btnSave");
      btn.disabled = true;
      btn.textContent = "Saving...";
      document.getElementById("loading").classList.remove("hidden");
      document.getElementById("loadingText").textContent = "Writing to Trial Layout...";
      document.getElementById("configContainer").classList.add("hidden");

      google.script.run
        .withSuccessHandler(function(response) {
           document.getElementById("loading").classList.add("hidden");
           document.getElementById("configContainer").classList.remove("hidden");
           btn.disabled = false;
           btn.textContent = "Save Configuration";
           alert("Success! Saved to " + response.slot);
        })
        .withFailureHandler(function(err) {
           document.getElementById("loading").classList.add("hidden");
           document.getElementById("configContainer").classList.remove("hidden");
           btn.disabled = false;
           btn.textContent = "Save Configuration";
           alert("Error: " + err.message);
        })
        .saveConfiguration(payload);
    }

    function logSelection() {
      console.log("Current Payload:", collectPayload());
    }
  </script>
</body>
</html>
